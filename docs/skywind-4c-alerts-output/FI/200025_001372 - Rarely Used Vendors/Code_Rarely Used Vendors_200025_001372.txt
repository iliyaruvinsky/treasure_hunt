  FUNCTION /SKN/F_SW_10_07_ACT_VEND_COUNT.
*"----------------------------------------------------------------------
*"*"Local Interface:
*"  EXPORTING
*"     VALUE(IS_ALERT) TYPE  CHAR1
*"  TABLES
*"      T_SELECT STRUCTURE  RSSELECT OPTIONAL
*"      T_DATA STRUCTURE  /SKN/S_SW_10_06_INACT_VEND OPTIONAL
*"----------------------------------------------------------------------
    DATA_SINGLE: SW_DEST       RFCDEST,
                 BACKDAYS      INT4,
                 LFA1_SPERR    SPERB_X,
                 LFA1_SPERM    SPERM_X,
                 LFA1_LOEVM    LOEVM_X,
                 LFB1_SPERR    SPERB_B,
                 LFB1_LOEVM    LOEVM_M,
                 LFM1_SPERM    SPERM_M,
                 LFM1_LOEVM    LOEVM_M,
                 WAERS_FR      WAERS.
    DATA_MULTY: LIFNR      LIFNR,
                BUKRS      BUKRS,
                EKORG      EKORG,
                KTOKK      KTOKK,
                KONZS      KONZS,
                FDGRV      FDGRV,
                ERDAT      ERDAT_RF,
                COUNTER    I,
                AMOUNT_MAX DMBTR,
                BALANCE_FR DMBTR,
                DATUM      SY-DATUM,
                GJAHR      GJAHR.
* Set default param.
    LV_BACKDAYS = 1.
    LV_WAERS_FR = 'USD'.
    SELECT_MULTY: LIFNR,
                  BUKRS,
                  EKORG,
                  KTOKK,
                  KONZS,
                  FDGRV,
                  ERDAT,
                  COUNTER,
                  AMOUNT_MAX,
                  BALANCE_FR,
                  DATUM.
    SELECT_SINGLE: SW_DEST,
                   BACKDAYS,
                   LFA1_SPERM,
                   LFA1_LOEVM,
                   LFB1_SPERR,
                   LFB1_LOEVM,
                   LFM1_SPERM,
                   LFM1_LOEVM,
                   WAERS_FR.
    CONVERT_MULTY: BUKRS ALPHA,
                   LIFNR ALPHA.
    TYPES: BEGIN OF TY_T001,
             LIFNR TYPE LFA1-LIFNR,
             BUKRS TYPE T001-BUKRS,
           END OF TY_T001,
           TT_T001 TYPE TABLE OF TY_T001.
    TYPES: BEGIN OF TY_LFC1,
      LIFNR TYPE LFB1-LIFNR,
      BUKRS TYPE LFB1-BUKRS,
      GJAHR TYPE LFC1-GJAHR,
      UMSAV TYPE LFC1-UMSAV,
      UM01S TYPE LFC1-UM01S,
      UM01H TYPE LFC1-UM01H,
      UM02S TYPE LFC1-UM02S,
      UM02H TYPE LFC1-UM02H,
      UM03S TYPE LFC1-UM03S,
      UM03H TYPE LFC1-UM03H,
      UM04S TYPE LFC1-UM04S,
      UM04H TYPE LFC1-UM04H,
      UM05S TYPE LFC1-UM05S,
      UM05H TYPE LFC1-UM05H,
      UM06S TYPE LFC1-UM06S,
      UM06H TYPE LFC1-UM06H,
      UM07S TYPE LFC1-UM07S,
      UM07H TYPE LFC1-UM07H,
      UM08S TYPE LFC1-UM08S,
      UM08H TYPE LFC1-UM08H,
      UM09S TYPE LFC1-UM09S,
      UM09H TYPE LFC1-UM09H,
      UM10S TYPE LFC1-UM10S,
      UM10H TYPE LFC1-UM10H,
      UM11S TYPE LFC1-UM11S,
      UM11H TYPE LFC1-UM11H,
      UM12S TYPE LFC1-UM12S,
      UM12H TYPE LFC1-UM12H,
      WAERS TYPE T001-WAERS,
    END OF TY_LFC1,
    TT_LFC1 TYPE STANDARD TABLE OF TY_LFC1.
    TYPES: BEGIN OF TY_LFC3,
      BUKRS TYPE LFC3-BUKRS,
      LIFNR TYPE LFC3-LIFNR,
      GJAHR TYPE LFC3-GJAHR,
      SHBKZ TYPE LFC3-SHBKZ,
      SALDV TYPE LFC3-SALDV,
      SOLLL TYPE LFC3-SOLLL,
      HABNL TYPE LFC3-HABNL,
      WAERS TYPE T001-WAERS,
    END OF TY_LFC3,
    TT_LFC3 TYPE STANDARD TABLE OF TY_LFC3.
    DATA: LV_START_DATE    TYPE ERDAT,
          LV_START_YEAR    TYPE GJAHR,
          LV_FIRST_YEAR    TYPE GJAHR,
          LV_START_MONTH   TYPE MONTH,
          LV_CURR_YEAR     TYPE GJAHR,
          LV_CURR_MONTH    TYPE MONTH,
          LV_COMP          TYPE CHAR10,
          LV_ACT           TYPE FLAG,
          LV_TABIX         TYPE I,
          LV_WHILE         TYPE STRING,
          LV_QUERY         TYPE STRING,
          LV_VAL           TYPE STRING,
          LV_WHERE         TYPE RFC_DB_OPT,
          LV_CHAR          TYPE CHAR20,
          LV_VALUE_HIGH    TYPE STRING VALUE '''0.00''',
          LV_VALUE         TYPE STRING VALUE '''0.00''',
          LV_COUNTER_TMP   TYPE I,
          LV_COUNTER_TOTAL TYPE I,
          LV_LINES         TYPE I,
          LV_LIFNR         TYPE LFC1-LIFNR,
          LV_BUKRS         TYPE LFC1-BUKRS,
          LV_COUNTER       TYPE I,
          LV_TOTAL_NORMAL  TYPE ZWRBTR,
          LV_TOTAL_SPEC    TYPE ZWRBTR,
          LV_TOTAL         TYPE ZWRBTR,
          LV_TOTAL_FR      TYPE ZWRBTR,
          LV_DEBIT         TYPE SOLLL,
          LV_PERIOD        TYPE NUMC5,
          LV_ZERO          TYPE I VALUE 0,
          LV_CREDIT        TYPE HABNL.
    DATA: LS_DATA     LIKE LINE OF T_DATA[],
          LS_DATA_TMP TYPE /SKN/S_SW_10_06_INACT_VEND,
          LS_LFC1     TYPE TY_LFC1,
          LS_LFC3     TYPE TY_LFC3,
          LS_T001     TYPE TY_T001.
    DATA: LT_DATA      LIKE TABLE OF T_DATA,
          LT_DATA_TMP  TYPE STANDARD TABLE OF /SKN/S_SW_10_06_INACT_VEND,
          LT_DATA_TMP2 TYPE STANDARD TABLE OF /SKN/S_SW_10_06_INACT_VEND,
          LT_LFC1      TYPE TT_LFC1,
          LT_LFC1_TMP  TYPE TT_LFC1,
          LT_QUERY     TYPE TABLE OF RFC_DB_OPT,
          LT_LFC3      TYPE TT_LFC3,
          LT_T001      TYPE TT_T001.
    DATA: BACKDAYS  TYPE I,
          DATE_FROM LIKE SY-DATUM,
          DATE_TO   LIKE SY-DATUM,
          REF_DATE  TYPE D.
    DATA: TIME_DIFF TYPE  INT4 .
    DATA: FLD(60) TYPE C.
    FIELD-SYMBOLS: <FS_VAL>  TYPE ANY,
                   <FS_DATA> LIKE LINE OF T_DATA[].
* if sw_dest is empty then on premise, else on cloud
    IF LV_SW_DEST IS NOT INITIAL.
      CALL FUNCTION '/SKN/FC_SW_10_07_ACT_VEND_COUN'
        IMPORTING
          IS_ALERT = IS_ALERT
        TABLES
          T_SELECT = T_SELECT
          T_DATA   = T_DATA.
    ENDIF.
    CHECK LV_SW_DEST IS INITIAL.
*"--- Run Cloud Mode -----
*--- Retrieve data
    CLEAR IS_ALERT .
    REFRESH T_DATA.
    CONVERT_MULTY: LIFNR ALPHA.
    IF R_BUKRS IS INITIAL.
      SELECT LFA1~LIFNR T001~BUKRS LFA1~ERDAT
        FROM LFA1 INNER JOIN LFB1 ON LFA1~LIFNR EQ LFB1~LIFNR
                  INNER JOIN T001 ON LFB1~BUKRS EQ T001~BUKRS
        INTO  TABLE LT_T001
        WHERE LFA1~LIFNR IN R_LIFNR[].
      IF LT_T001 IS NOT INITIAL.
        SORT LT_T001 BY BUKRS.
        DELETE ADJACENT DUPLICATES FROM LT_T001 COMPARING BUKRS.
        LOOP AT LT_T001 INTO LS_T001.
          RS_BUKRS-SIGN   = 'I'.
          RS_BUKRS-OPTION = 'EQ'.
          RS_BUKRS-LOW    = LS_T001-BUKRS.
          APPEND RS_BUKRS TO R_BUKRS.
        ENDLOOP.
        SORT R_BUKRS BY LOW.
      ENDIF.
    ENDIF.
    LV_START_DATE  = SY-DATUM - LV_BACKDAYS.
    LV_START_YEAR  = LV_START_DATE(4).
    LV_START_MONTH = LV_START_DATE+4(2).
    LV_CURR_YEAR  = SY-DATUM(4).
    LV_CURR_MONTH = SY-DATUM+4(2).
    LV_START_DATE  = SY-DATUM - LV_BACKDAYS.
    LV_START_YEAR  = LV_START_DATE(4).
    LV_FIRST_YEAR  = LV_START_YEAR.
    LV_START_MONTH = LV_START_DATE+4(2).
* Set Fiscal Year range for main condition
    REFRESH R_GJAHR.
    CLEAR RS_GJAHR.
    RS_GJAHR-SIGN   = 'I'.
    RS_GJAHR-OPTION = 'BT'.
    RS_GJAHR-LOW    = LV_START_YEAR.
    RS_GJAHR-HIGH   = LV_CURR_YEAR.
    APPEND RS_GJAHR TO R_GJAHR[].
*** 07.06.21++
* Set default counter
    IF R_COUNTER IS INITIAL.
      RS_COUNTER-SIGN   = 'I'.
      RS_COUNTER-OPTION = 'EQ'.
      RS_COUNTER-LOW    =  0.
      APPEND RS_COUNTER TO R_COUNTER.
    ENDIF.
*** 07.06.21++
* Set Vendor Creation date
    REFRESH R_ERDAT.
    CLEAR RS_ERDAT.
    RS_ERDAT-SIGN   = 'I'.
*** 28.06.22--
*** 07.06.21++
*    IF lv_zero IN r_counter[].
*      rs_erdat-option = 'LE'.
*    ELSE.
**** 07.06.21++
*      rs_erdat-option = 'GE'.
*    ENDIF.
*** 28.06.22--
    RS_ERDAT-OPTION = 'LE'.   " 28.06.22++
    RS_ERDAT-LOW    = LV_START_DATE.
    APPEND RS_ERDAT TO R_ERDAT[].
    SELECT LFB1~LIFNR LFB1~BUKRS LFB1~FDGRV LFB1~SPERR AS LFB1_SPERR LFB1~LOEVM AS LFB1_LOEVM
           LFM1~EKORG LFM1~SPERM AS LFM1_SPERM LFM1~LOEVM AS LFM1_LOEVM
           LFA1~NAME1 LFA1~KONZS LFA1~KTOKK LFA1~SPERR AS LFA1_SPERR LFA1~SPERM AS LFA1_SPERM
           LFA1~LOEVM AS LFA1_LOEVM LFA1~KTOKK LFA1~KONZS
           T001~BUTXT
      FROM LFB1 INNER JOIN LFA1      ON LFB1~LIFNR EQ LFA1~LIFNR
                INNER JOIN T001      ON LFB1~BUKRS EQ T001~BUKRS
                LEFT OUTER JOIN LFM1 ON LFA1~LIFNR EQ LFM1~LIFNR
      INTO CORRESPONDING FIELDS OF TABLE LT_DATA
      WHERE LFB1~LIFNR  IN R_LIFNR[]
      AND   LFB1~BUKRS  IN R_BUKRS[]
      AND   LFB1~SPERR  EQ LV_LFB1_SPERR
      AND   LFB1~LOEVM  EQ LV_LFB1_LOEVM
      AND   LFA1~ERDAT  IN R_ERDAT[]
      AND   LFA1~SPERR  EQ LV_LFA1_SPERR
      AND   LFA1~SPERM  EQ LV_LFA1_SPERM
      AND   LFA1~LOEVM  EQ LV_LFA1_LOEVM.
    IF LT_DATA IS NOT INITIAL.
      SORT LT_DATA[] BY LIFNR BUKRS.
      DELETE ADJACENT DUPLICATES FROM LT_DATA COMPARING LIFNR BUKRS.
    ENDIF.
    CHECK LT_DATA IS NOT INITIAL.
    READ TABLE R_COUNTER INTO RS_COUNTER INDEX 1.
    IF LT_DATA IS INITIAL.
      EXIT.
    ENDIF.
*
    IF LT_DATA IS NOT INITIAL.
      SELECT LFC1~LIFNR LFC1~BUKRS LFC1~GJAHR
             LFC1~UMSAV
             LFC1~UM01S LFC1~UM01H LFC1~UM02S LFC1~UM02H LFC1~UM03S LFC1~UM03H
             LFC1~UM04S LFC1~UM04H LFC1~UM05S LFC1~UM05H LFC1~UM06S LFC1~UM06H
             LFC1~UM07S LFC1~UM07H LFC1~UM08S LFC1~UM08H LFC1~UM09S LFC1~UM09H
             LFC1~UM10S LFC1~UM10H LFC1~UM11S LFC1~UM11H LFC1~UM12S LFC1~UM12H
        FROM LFC1 LEFT OUTER JOIN T001 ON LFC1~BUKRS EQ T001~BUKRS
        INTO CORRESPONDING FIELDS OF TABLE LT_LFC1
        FOR ALL ENTRIES IN LT_DATA[]
        WHERE LFC1~LIFNR EQ LT_DATA-LIFNR
        AND   LFC1~BUKRS EQ LT_DATA-BUKRS
        AND   LFC1~GJAHR IN R_GJAHR[].
    ENDIF.
    CHECK LT_LFC1 IS NOT INITIAL.
*** Yuri C.++ 06.01.19
    SORT LT_LFC1 BY LIFNR BUKRS.
    IF RS_COUNTER-LOW > 0 OR RS_COUNTER-HIGH > 0.
      SORT LT_LFC1 BY LIFNR BUKRS GJAHR.
      SORT LT_DATA BY LIFNR BUKRS.
      LOOP AT LT_LFC1 INTO LS_LFC1.
        LV_TABIX = SY-TABIX.
        CLEAR: LV_COUNTER_TMP, LT_DATA_TMP.
        READ TABLE LT_DATA ASSIGNING <FS_DATA> WITH KEY LIFNR = LS_LFC1-LIFNR
                                                        BUKRS = LS_LFC1-BUKRS
                                                        BINARY SEARCH.
        IF SY-SUBRC EQ 0.
          IF LV_START_YEAR EQ LS_LFC1-GJAHR.
            LV_WHILE      = LV_START_MONTH.
            LV_CURR_MONTH = LV_START_MONTH.
          ELSE.
            LV_CURR_MONTH = 1.
            LV_WHILE      = 1.
          ENDIF.
          WHILE LV_WHILE <= 12.
            IF LV_LIFNR <> LS_LFC1-LIFNR OR LV_BUKRS <> LS_LFC1-BUKRS.
              CLEAR: LV_COUNTER.
              DESCRIBE TABLE LT_DATA_TMP LINES LV_COUNTER.
              IF LV_COUNTER IN R_COUNTER[] AND LT_DATA_TMP IS NOT INITIAL.
                LOOP AT LT_DATA_TMP ASSIGNING <FS_DATA>.
                  <FS_DATA>-COUNTER = LV_COUNTER.
                ENDLOOP.
                APPEND LINES OF LT_DATA_TMP TO LT_DATA_TMP2.
                CLEAR: LT_DATA_TMP.
              ENDIF.
              CLEAR: LV_COUNTER_TOTAL.
              LV_LIFNR = LS_LFC1-LIFNR.
              LV_BUKRS = LS_LFC1-BUKRS.
            ENDIF.
            CLEAR: LV_COMP.
            CONCATENATE 'UM' LV_CURR_MONTH 'H' INTO LV_COMP.
            ASSIGN COMPONENT LV_COMP OF STRUCTURE LS_LFC1 TO <FS_VAL>.
            IF <FS_VAL> NE 0.
              CLEAR: LS_DATA_TMP-AMOUNT, LS_DATA_TMP-GJAHR, LS_DATA_TMP-WAERS,
                     LS_DATA_TMP-PERIOD.
              LV_COUNTER_TMP = LV_COUNTER_TMP + 1.
              LS_DATA_TMP-GJAHR  = LV_START_YEAR.
**** 28.06.22--
*              CONCATENATE lv_start_month ls_lfc1-gjahr INTO ls_data_tmp-period
*                SEPARATED BY '/'.
**** 28.06.22--
**** 28.06.22++
              CONCATENATE LV_CURR_MONTH LS_LFC1-GJAHR INTO LS_DATA_TMP-PERIOD
                SEPARATED BY '/'.
**** 28.06.22++
              LS_DATA_TMP-AMOUNT = <FS_VAL>.
              LS_DATA_TMP-WAERS  = LS_LFC1-WAERS.
              APPEND LS_DATA_TMP TO LT_DATA_TMP.
            ENDIF.
            LV_WHILE      = LV_WHILE + 1.
            LV_CURR_MONTH = LV_CURR_MONTH + 1.
          ENDWHILE.
          LV_COUNTER_TOTAL = LV_COUNTER_TOTAL + LV_COUNTER_TMP.
          IF LV_COUNTER_TOTAL IN R_COUNTER[] OR LV_COUNTER_TOTAL LT RS_COUNTER-LOW.
            SORT LT_DATA_TMP BY LIFNR BUKRS GJAHR.
            IF LV_LINES EQ LV_TABIX.    " Last Row at LFC1
              DESCRIBE TABLE LT_DATA_TMP LINES LV_COUNTER.
              IF LV_COUNTER IN R_COUNTER[] AND LT_DATA_TMP IS NOT INITIAL.
                LOOP AT LT_DATA_TMP ASSIGNING <FS_DATA>.
                  <FS_DATA>-COUNTER = LV_COUNTER.
                ENDLOOP.
                APPEND LINES OF LT_DATA_TMP TO LT_DATA_TMP2.
                CLEAR: LT_DATA_TMP.
              ENDIF.
            ENDIF.
          ELSE.
            CLEAR: LT_DATA_TMP.
            SORT LT_DATA BY LIFNR BUKRS.
            DELETE LT_DATA WHERE LIFNR EQ LS_LFC1-LIFNR
                           AND   BUKRS EQ LS_LFC1-BUKRS.
          ENDIF.
        ELSE.
          CLEAR: LT_DATA_TMP.
          SORT LT_DATA     BY LIFNR BUKRS.
          DELETE LT_DATA WHERE LIFNR EQ LS_LFC1-LIFNR
                         AND   BUKRS EQ LS_LFC1-BUKRS.
        ENDIF.
      ENDLOOP.
    ENDIF.
    CHECK LT_DATA IS NOT INITIAL.
    IF NOT LV_ZERO IN R_COUNTER.
      DELETE LT_DATA_TMP2 WHERE COUNTER NOT IN R_COUNTER[].
      LT_DATA = LT_DATA_TMP2.
    ENDIF.
    IF LT_DATA[] IS NOT INITIAL.
      SORT LT_DATA BY LIFNR BUKRS.
* Select all vendors related to T_DATA and for current year
      CLEAR: LT_LFC1.
      LV_CURR_YEAR = SY-DATUM(4).
      SELECT LFC1~LIFNR LFC1~BUKRS LFC1~GJAHR LFC1~UMSAV
             LFC1~UM01S LFC1~UM01H LFC1~UM02S LFC1~UM02H LFC1~UM03S LFC1~UM03H
             LFC1~UM04S LFC1~UM04H LFC1~UM05S LFC1~UM05H LFC1~UM06S LFC1~UM06H
             LFC1~UM07S LFC1~UM07H LFC1~UM08S LFC1~UM08H LFC1~UM09S LFC1~UM09H
             LFC1~UM10S LFC1~UM10H LFC1~UM11S LFC1~UM11H LFC1~UM12S LFC1~UM12H
             T001~WAERS
        FROM LFC1 LEFT OUTER JOIN T001 ON LFC1~BUKRS EQ T001~BUKRS
        INTO CORRESPONDING FIELDS OF TABLE LT_LFC1
        FOR ALL ENTRIES IN LT_DATA
        WHERE LFC1~LIFNR EQ LT_DATA-LIFNR
        AND   LFC1~BUKRS EQ LT_DATA-BUKRS
        AND   LFC1~GJAHR IN R_GJAHR[].        "EQ lv_curr_year.
      SELECT LFC3~LIFNR LFC3~BUKRS LFC3~GJAHR LFC3~SHBKZ LFC3~SALDV LFC3~SOLLL LFC3~HABNL
             T001~WAERS
        FROM LFC3 LEFT OUTER JOIN T001 ON LFC3~BUKRS EQ T001~BUKRS
        INTO CORRESPONDING FIELDS OF TABLE LT_LFC3
        FOR ALL ENTRIES IN LT_DATA
        WHERE LFC3~LIFNR EQ LT_DATA-LIFNR
        AND   LFC3~BUKRS EQ LT_DATA-BUKRS
        AND   LFC3~GJAHR IN R_GJAHR[].       "EQ lv_curr_year.
      IF SY-SUBRC = 0.
        SORT LT_LFC3 BY LIFNR BUKRS GJAHR.
      ENDIF.
    ENDIF.
    LV_CURR_YEAR = SY-DATUM(4).
    SORT LT_LFC1 BY LIFNR BUKRS GJAHR.
* Calculate debit, credit and balance of current year
    LOOP AT LT_DATA ASSIGNING <FS_DATA>.
****** Description *****************************
****** Description *****************************
      CLEAR: LV_TOTAL_NORMAL, LV_TOTAL_SPEC, LS_LFC1, LS_LFC3, LV_TOTAL.
* LFC3
* Calculate balance of spec. G/L
      LOOP AT LT_LFC3 INTO LS_LFC3 WHERE LIFNR EQ <FS_DATA>-LIFNR
                                   AND   BUKRS EQ <FS_DATA>-BUKRS
                                   AND   GJAHR EQ LV_CURR_YEAR.
        IF <FS_DATA>-WAERS IS INITIAL.
          <FS_DATA>-WAERS = LS_LFC3-WAERS.
        ENDIF.
        LV_TOTAL_SPEC = LS_LFC3-SALDV + LS_LFC3-SOLLL - LS_LFC3-HABNL.
      ENDLOOP.
      IF LV_WAERS_FR IS NOT INITIAL AND LS_LFC3 IS NOT INITIAL AND
         LV_WAERS_FR NE LS_LFC3-WAERS AND LV_TOTAL_SPEC IS NOT INITIAL.
        CLEAR: LV_TOTAL_FR.
        <FS_DATA>-WAERS_FR = LV_WAERS_FR.
        CALL FUNCTION 'CONVERT_TO_FOREIGN_CURRENCY'
          EXPORTING
            DATE             = SY-DATUM
            FOREIGN_CURRENCY = LV_WAERS_FR   " 'USD'
            LOCAL_AMOUNT     = LV_TOTAL_SPEC
            LOCAL_CURRENCY   = LS_LFC3-WAERS
          IMPORTING
            FOREIGN_AMOUNT   = LV_TOTAL_FR
          EXCEPTIONS
            NO_RATE_FOUND    = 1
            OVERFLOW         = 2
            NO_FACTORS_FOUND = 3
            NO_SPREAD_FOUND  = 4
            DERIVED_2_TIMES  = 5
            OTHERS           = 6.
      ELSE.
        LV_TOTAL_FR = LV_TOTAL_SPEC.
      ENDIF.
      <FS_DATA>-BALANCE_SPEC    = <FS_DATA>-BALANCE_SPEC    + LV_TOTAL_SPEC.
      <FS_DATA>-BALANCE_SPEC_FR = <FS_DATA>-BALANCE_SPEC_FR + LV_TOTAL_FR.
* LFC1
      LOOP AT LT_LFC1 INTO LS_LFC1 WHERE LIFNR EQ <FS_DATA>-LIFNR
                                   AND   BUKRS EQ <FS_DATA>-BUKRS
                                   AND   GJAHR EQ LV_CURR_YEAR.
        CLEAR: LV_CREDIT, LV_DEBIT.
        IF <FS_DATA>-WAERS IS INITIAL.
          <FS_DATA>-WAERS = LS_LFC1-WAERS.
        ENDIF.
*** Begin 29.03.22--
*        lv_curr_month = 1.
*        lv_while      = 1.
*** End 29.03.22--
*** Begin 29.03.22++
        IF LV_START_YEAR IS NOT INITIAL.
          IF LV_START_YEAR LT SY-DATUM(4).
            LV_CURR_MONTH = 1.
            LV_WHILE      = 1.
          ELSE.
            LV_CURR_MONTH = LV_START_MONTH.
            LV_WHILE      = LV_START_MONTH.
          ENDIF.
        ELSE.
          LV_CURR_MONTH = 1.
          LV_WHILE      = 1.
        ENDIF.
*** End 29.03.22++
        WHILE LV_WHILE GE 12 .
          CONCATENATE 'UM' LV_CURR_MONTH 'H' INTO LV_COMP.
          ASSIGN COMPONENT LV_COMP OF STRUCTURE LS_LFC1 TO <FS_VAL>.
          IF SY-SUBRC = 0 AND <FS_VAL> IS ASSIGNED.
            LV_CREDIT = LV_CREDIT + <FS_VAL>.
            UNASSIGN <FS_VAL>.
          ENDIF.
          CLEAR: LV_COMP.
          CONCATENATE 'UM' LV_CURR_MONTH 'S' INTO LV_COMP.
          ASSIGN COMPONENT LV_COMP OF STRUCTURE LS_LFC1 TO <FS_VAL>.
          IF SY-SUBRC = 0 AND <FS_VAL> IS ASSIGNED.
            LV_DEBIT = LV_DEBIT + <FS_VAL>.
            UNASSIGN <FS_VAL>.
          ENDIF.
          ADD 1 TO LV_CURR_MONTH.
          ADD 1 TO LV_WHILE.
        ENDWHILE.
*        lv_total_normal = lv_total_normal + ( ls_lfc1-umsav + lv_credit + lv_debit ).   " 28.06.22--
        LV_TOTAL_NORMAL = LV_TOTAL_NORMAL + ( LS_LFC1-UMSAV + LV_DEBIT - LV_CREDIT ).    " 28.06.22++
      ENDLOOP.
******** 22.02.19
      IF LV_WAERS_FR IS NOT INITIAL AND LS_LFC1 IS NOT INITIAL AND
         LV_WAERS_FR NE LS_LFC1-WAERS AND LV_TOTAL_NORMAL IS NOT INITIAL.
        CLEAR: LV_TOTAL_FR.
        <FS_DATA>-WAERS_FR = LV_WAERS_FR.
        CALL FUNCTION 'CONVERT_TO_FOREIGN_CURRENCY'
          EXPORTING
            DATE             = SY-DATUM
            FOREIGN_CURRENCY = LV_WAERS_FR   " 'USD'
            LOCAL_AMOUNT     = LV_TOTAL_NORMAL
            LOCAL_CURRENCY   = LS_LFC1-WAERS
          IMPORTING
            FOREIGN_AMOUNT   = LV_TOTAL_FR
          EXCEPTIONS
            NO_RATE_FOUND    = 1
            OVERFLOW         = 2
            NO_FACTORS_FOUND = 3
            NO_SPREAD_FOUND  = 4
            DERIVED_2_TIMES  = 5
            OTHERS           = 6.
      ELSE.
        LV_TOTAL_FR = LV_TOTAL_NORMAL.
      ENDIF.
      <FS_DATA>-BALANCE_NORMAL    = <FS_DATA>-BALANCE_NORMAL    + LV_TOTAL_NORMAL. " Balance total normal   of LFC1
      <FS_DATA>-BALANCE_NORMAL_FR = <FS_DATA>-BALANCE_NORMAL_FR + LV_TOTAL_FR.
* Total balance
      LV_TOTAL = <FS_DATA>-BALANCE_NORMAL + <FS_DATA>-BALANCE_SPEC.
      IF LV_WAERS_FR IS NOT INITIAL AND <FS_DATA>-WAERS IS NOT INITIAL AND
         LV_WAERS_FR NE LS_LFC1-WAERS AND LV_TOTAL IS NOT INITIAL.
        CLEAR: LV_TOTAL_FR.
        <FS_DATA>-WAERS_FR = LV_WAERS_FR.
        CALL FUNCTION 'CONVERT_TO_FOREIGN_CURRENCY'
          EXPORTING
            DATE             = SY-DATUM
            FOREIGN_CURRENCY = LV_WAERS_FR   " 'USD'
            LOCAL_AMOUNT     = LV_TOTAL
            LOCAL_CURRENCY   = <FS_DATA>-WAERS
          IMPORTING
            FOREIGN_AMOUNT   = LV_TOTAL_FR
          EXCEPTIONS
            NO_RATE_FOUND    = 1
            OVERFLOW         = 2
            NO_FACTORS_FOUND = 3
            NO_SPREAD_FOUND  = 4
            DERIVED_2_TIMES  = 5
            OTHERS           = 6.
      ELSE.
        IF <FS_DATA>-WAERS_FR IS INITIAL.
          <FS_DATA>-WAERS_FR = LV_WAERS_FR.
        ENDIF.
        LV_TOTAL_FR = LV_TOTAL.
      ENDIF.
******** 22.02.19
      <FS_DATA>-BALANCE_TOTAL = LV_TOTAL.
      IF LV_TOTAL_FR IN R_BALANCE_FR[].
        <FS_DATA>-BALANCE_TOTAL_FR = LV_TOTAL_FR.
        APPEND <FS_DATA> TO T_DATA.
      ENDIF.
    ENDLOOP.
    READ TABLE T_DATA INDEX 1.
    CHECK NOT SY-TFILL  IS INITIAL .
    IS_ALERT = 'X' .
  ENDFUNCTION.